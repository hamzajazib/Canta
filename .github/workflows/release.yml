name: ğŸ“¦ğŸš€ Build & prepare draft Android release

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  attestations: write

jobs:
  deployAndroid:
    permissions: write-all
    name: ğŸ¤–ğŸ“¦ğŸš€ Build & prepare Android release
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: "21.x"
          cache: "gradle"
          distribution: "adopt"

      - name: ğŸ” Retrieve base64 keystore
        uses: timheuer/base64-to-file@v1.2
        with:
          fileName: "android-keystore.jks"
          fileDir: "${{ github.workspace }}/"
          encodedString: ${{ secrets.KEYSTORE_FILE_BASE64 }}

      - name: ğŸ“ğŸ” Create keystore.properties file
        env:
          KEYSTORE_PROPERTIES_PATH: ${{ github.workspace }}/key.properties
        run: |
          echo "storeFile=${{ github.workspace }}/android-keystore.jks" > $KEYSTORE_PROPERTIES_PATH
          echo "keyAlias=${{ secrets.KEYSTORE_KEY_ALIAS }}" >> $KEYSTORE_PROPERTIES_PATH
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> $KEYSTORE_PROPERTIES_PATH
          echo "keyPassword=${{ secrets.KEYSTORE_KEY_PASSWORD }}" >> $KEYSTORE_PROPERTIES_PATH

      - name: ğŸ“Œ Extract version_name from gradle.properties
        id: extract_version
        run: |
          # read version_name
          version=$(grep "^version_name=" app/gradle.properties | cut -d'=' -f2)
          echo "VERSION_NAME=$version" >> $GITHUB_ENV
          echo "::set-output name=tag::v$version"

      - name: ğŸ¤–ğŸ“¦ Build Android APKs
        run: ./gradlew app:assembleRelease

      - name: ğŸ“ Generate SHA-256 checksums
        run: |
          cd app/build/outputs/apk/release/
          sha256sum *.apk > SHA256SUMS.txt

      - name: "Echo SHA-256 sums"
        run: cat app/build/outputs/apk/release/SHA256SUMS.txt

      - name: ğŸ”§ Setup GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh config set prompt disabled

      - name: ğŸ›¡ï¸ Generate artifact attestation
        id: attest
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: 'app/build/outputs/apk/release/*.apk'

      - name: ğŸ“¦ Create GitHub release draft
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ env.VERSION_NAME }}" \
            --draft \
            --title "Canta ${{ env.VERSION_NAME }}" \
            --notes "" \
            --target "$GITHUB_SHA"

      - name: ğŸ“ Upload APKs, checksums & attestation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ env.VERSION_NAME }}"
          gh release upload "$TAG" app/build/outputs/apk/release/*.apk
          gh release upload "$TAG" app/build/outputs/apk/release/SHA256SUMS.txt
          gh release upload "$TAG" "${{ steps.attest.outputs.bundle-path }}"
